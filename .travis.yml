language: node_js
node_js:
  - "10"

env:
  MIGRATION_RESULT: ""

stages:
  - test

jobs:
  include:
    - stage: test
      name: "Run test"
      services:
        - docker
      if: type = pull_request
      before_install:
#        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      script:
        - docker-compose down -v
        - docker-compose pull
        - docker-compose build --no-cache
        - MIGRATION_RESULT=$(docker-compose run migrate)
        - export SIDECHAIN_ADDRESS=$(echo \"$MIGRATION_RESULT\" | perl -lne '/SideChain.*contract address:\s+(0x.{40})/ && print $1')
        - sed -i "s/0xc87395b45C1c199F25a6c2Be43515C41d53751Af/$SIDECHAIN_ADDRESS/g" ./genesis.json
        - docker-compose up -d ganache
        - docker-compose up -d echo
        - docker-compose up --exit-code-from pytests pytests
      before_install:
        - docker-compose down -v
        - docker-compose rm -fv
